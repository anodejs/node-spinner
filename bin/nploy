#!/usr/bin/env node

var program = require('commander')
function range (val) {
  return val.split('..').map(function (el) {
    return parseInt(el, 10)
  })
}

program
  .version('0.1.2')
  .option('-r, --range <a>..<b>', 'Port range [7000..7099]', range)
  .option('-t, --time <seconds>', 'Time to idle [15]', 15, parseInt)
  .option('-p, --port <port>', 'Port to listen to [80]', 80, parseInt)
  .option('-H, --host <host>', 'Host to listen to [0.0.0.0]', '0.0.0.0')
  .option('-c, --config <config>', 'Config file [./nploy.cfg]', './nploy.cfg')
  .option('-d, --dir <dir>', 'Current working dir [.]', '.')
  .option('-v, --verbose', 'Show some debugging information', false)
  .parse(process.argv)


var nploy = require('../lib/nploy');

if (program.verbose) {
  program.debug = true
  program.output = 'console'
}

var server = nploy.start(program, function() {
  console.log('listening on http://' + server.endpoint.host + ':' + server.endpoint.port + '/')
});

process.on('SIGTERM', function() {
  server.close()
})

console.log('-----------')
console.log('-- nploy --')
console.log('-----------')
console.log('config:', server.config)
console.log('range:', server.router.range)
console.log('time to idle:', (server.router.idletime) + 's')
